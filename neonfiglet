#!/usr/bin/env bash
# neonfiglet: rainbow colored figlet / stdin text animation
# Copyright (C) 2025 joknarf
# License: MIT (see LICENSE file)
# Author: joknarf

lolcat() {
  awk '
    BEGIN {
        freq = 0.1
        spread = 3.0
        pi = atan2(0,-1)
        offset = 0
    }

    function rainbow(f,s,  t, r,g,b) {
        t = f*s
        r = sin(t + 0) * 127 + 128
        g = sin(t + 2*pi/3) * 127 + 128
        b = sin(t + 4*pi/3) * 127 + 128
        return sprintf("%d;%d;%d", r,g,b)
    }
    {
        nchars = split($0, chars, "")
        for(i=1; i<=nchars; i++) {
          if (chars[i] == " ") printf(" ")
          else {
            color = rainbow(freq, offset+i/spread)
            printf("\033[38;2;%sm%s", color, chars[i])
          }
        }
        offset += spread
        printf("\n")
    }
    END {
      printf("\033[39m")
    }' "$@"
}

s2cs() {
  cs=$(LANG=C;printf '%.2f' "$1")
  cs="${cs/[.]/}"
  cs=$((10#$cs))
}

now() {
  typeset cs
  now="${EPOCHREALTIME/,/.}"
  [ "$now" ] || read -r now _ 2>/dev/null </proc/uptime
  [ "$now" ] || now=$SECONDS
  s2cs "$now"; now="$cs"
}

right_pad_lines() {
  local s i 
  max=0
  for s in "${lines[@]}"; do (( ${#s} > max )) && max=${#s}; done
  for i in "${!lines[@]}"; do printf -v s "%-*s" "$max" "${lines[i]}";lines[i]=$s; done
}

align_center() {
  nspaces=$(((width-$max)/2))          # center align
  spaces=$(printf '%*s' $nspaces '')  # prefix spaces
  lines=( "${lines[@]/#/$spaces}" )   # add spaces  
}

align_right() {
  nspaces=$((width-$max))             # right align
  spaces=$(printf '%*s' $nspaces '')  # prefix spaces
  lines=( "${lines[@]/#/$spaces}" )   # add spaces  
}

do_scroll_down() {
  printf '\n%.0s' $(eval echo "{1..$len}")
  tput cuu $len
  for ((i=1;i<=$len;i++)) ;do
    printf "%s\n" "${lines[@]:$((len-i))}" |lolcat offset=$off "$@"
    tput cuu $i
    off+=-10
    sleep $delay
  done
}

do_scroll_up() {
  printf '\n%.0s' $(eval echo "{1..$len}")
  for ((i=1;i<=$len;i++)) ;do
    tput cuu $i
    printf "%s\n" "${lines[@]:0:$i}" |lolcat offset=$off "$@"
    off+=-10
    sleep $delay
  done
  tput cuu $len
}

do_scroll_right() {
  for ((pos=${#lines[0]}-7;pos>=0;pos-=8));do
    chars=$(printf '%*s' $pos '')
    printf "%s\n" "${lines[@]/#${chars// /?}/}" |lolcat offset=$off "$@"
    tput cuu $len
    off+=-10
    sleep $delay
  done
}

do_scroll_left() {
  # width padding
  d=$((width-${#lines[0]}))
  rspaces=$(printf '%*s' $d '')
  lines=( "${lines[@]/%/$rspaces}" )
  for ((pos=width-max;pos>=0;pos-=8));do
    spaces=$(printf '%*s' $pos '')
    l=("${lines[@]/#/$spaces}")
    printf "%s\n" "${l[@]/%${spaces// /?}/}" |lolcat offset=$off "$@"
    tput cuu $len
    off+=-10
    sleep $delay
  done
}

do_write() {
  for ((pos=$max;pos>=0;pos-=8));do
    chars=$(printf '%*s' $pos '')
    printf "%s\n" "${lines[@]/%${chars// /?}/}" |lolcat offset=$off "$@"
    tput cuu $len
    off+=-10
    sleep $delay
  done
}

# bash <4
type mapfile >/dev/null 2>&1 || mapfile() {
  typeset o="$IFS"
  # disable globbing to prevent filenames expansion
  IFS=$'\n'; set -f; lines=( $(< /dev/stdin) ); set +f; IFS="$o"
}

do_anim() {
  typeset lines twidth nspaces spaces timeout="$1" delay="$2" len cs
  typeset -i off=$RANDOM
  s2cs "$timeout"; timeout="$cs"
  s2cs "$delay"; timeout=$((timeout-cs))
  shift 2
  mapfile -t lines                    # put text from stdin into array
  right_pad_lines
  $center && align_center
  $right && align_right
  len="${#lines[@]}"
  tput civis                          # hide cursor
  now; stime=$now
  end=$(($stime+$timeout))

  case "$scroll" in
    u|up) do_scroll_up;;
    d|down) do_scroll_down;;
    r|right) do_scroll_right;;
    l|left) do_scroll_left;;
    w|write) do_write;;
  esac

  off+=-10
  printf '%s\n' "${lines[@]}" |lolcat freq=0.15 spread=2.0 offset=$off "$@"
  now
  while [ $now -lt $end ];do       # anim colors changing rainbow offset
    sleep $delay
    tput cuu $len              # cursor up nb logo lines
    off+=-10
    printf '%s\n' "${lines[@]}" |lolcat freq=0.15 spread=2.0 offset=$off "$@"
    now
  done
}

usage() {
  center=false
  echo "usage: ${0##*/} [-t <tmoutsec>] [-s <sleepsec>] [-S <dir>] [-F] [figletopts] [<message>] [lolcatopts]

    -S <dir>      : initial scroll direction (u, d, l, r, write, none)
    -F            : display <message> with all fonts in <fontdir>
    -t <tmoutsec> : animation duration (default 2.0)
    -s <sleepsec> : sleep between frales (default 0.1)
    <message>     : message to display (if not uses stdin w/o figlet)
    figletopts:
      -l|-r : left / right align (default center)
      -d <fontdir> : font directory
      -f <font> : font name
    lolcatopts:
      spread=<spread> : default 2.0
      freq=<freq>     : default 0.15
" | fold -w $width| do_anim 0.5 0.01
  exit 1
}

trap 'tput cnorm' EXIT              # restore cursor at exit
timeout=2.0
delay=0.1
allfonts=false
scroll=u
width=$(tput cols)
fontdir=$(figlet -I2 2>/dev/null)
figargs=()
center=true
right=false
while getopts ":t:s:d:f:lrS:Fh" opt; do
  case "$opt" in
    t) timeout="$OPTARG";;
    s) delay="$OPTARG";;
    l) figargs+=("-$opt");center=false;;
    r) figargs+=("-$opt");center=false;right=true;;
    F) allfonts=true;;
    S) scroll="$OPTARG";;
    f|d) figargs+=(-"$opt" "$OPTARG");fontdir="$OPTARG";;
    h) usage;;
    :) echo "Option -$OPTARG requires an argument"; usage ;;
    \?) echo "Invalid option: -$OPTARG"; usage;;
  esac
done

shift $((OPTIND - 1))
text="$1"
shift
$allfonts && {
  center=false
  right=false
  cd "$fontdir"
  for i in $(ls *.?lf */*.?lf 2>/dev/null);do
    font=${i%.*}
    echo $font":"
    font=${font##*/}
    figlet -c -w $width "${figargs[@]}" -f "$i" "${text:-${font^} 123}" |do_anim $timeout $delay "$@"
  done
  exit
}
if [ "$text" ] ;then
  center=false # done by figlet
  right=false
  ! type figlet >/dev/null 2>&1 && do_anim $timeout $delay "$@" <<<"$text" && exit
  figlet -c -w $width "${figargs[@]}" "$text" |do_anim $timeout $delay "$@"
else
  printf '\033[?7l'    # disable line wrapping
  do_anim $timeout $delay "$@"
  printf '\033[?7h'    # enable line wrapping
fi
